#!/bin/sh
##============================================================================
## ConfigureWorfNAT
##
## Author: Dave Billin
##
## Description:
##   This script sets up iptables rules to create a port-forwarding
##   NAT used to connect the internal AUV network entities with an
##   external PC.  The Worf WiFi interface is Masqueraded so that
##   all communications leaving the AUV will appear as if they are
##   coming from the WiFi interface address.  Specific ports are 
##   aliased at the WiFi interface and forwarded to the appropriate 
##   internal network entities to allow useful protocols (FTP, 
##   MOOSDB, etc.) to be exposed to an outside PC.
##============================================================================

#set -x

# Path to the iptables utility
IPTABLES=/usr/sbin/iptables
DEPMOD=/sbin/depmod
MODPROBE=/sbin/modprobe


## Absolute path to the AUV vehicle-specific data file 
VEHICLE_CONFIG_FILE="/usr/share/VehicleConfig.cfg"

## The iptables settings generated by this script will be
## saved to this file
NATCONFIG_FILE="/etc/YellowSubNAT.conf"


## Network interface used to communicate with the external world
IF_EXT=wlan0

## Network interface used to communicate with the internal subnet
IF_INT=eth0




##----------------------------------------------------------------------------
## ADDRESS AND PORT CONSTANTS
##----------------------------------------------------------------------------

# IP address of IF_INT
IF_INT_IPADDRESS=192.168.1.1

# IP addresses inside the AUV
WORF_IP=192.168.1.1
PICARD_IP=192.168.1.2
SPOCK_IP=192.168.1.103
SCOTTY_IP=192.168.1.104
DSP_IP=192.168.1.105


##----------------------------------------
# Standard port numbers
PORT_FTP_DATA=20
PORT_FTP_CONTROL=21
PORT_SSH=22
PORT_TFTP=69
PORT_SFTP=115
PORT_HTTPS=443
##----------------------------------------





##----------------------------------------------------------------------------
## INITIALIZATION
##----------------------------------------------------------------------------

## Flush the current routing tables
iptables -F
iptables -t nat -F
iptables -t mangle -F
iptables --delete-chain
iptables -t nat --delete-chain


## Read the vehicle ID from the vehicle configuration file or fail
if [ -f ${VEHICLE_CONFIG_FILE} ]
then
    VEHICLE_ID="$(gawk -F= '(/AUV_VEHICLE_ID/){print int($2)}' ${VEHICLE_CONFIG_FILE})"
else
    echo "Failed to read Vehicle ID from" ${VEHICLE_CONFIG_FILE}"!"
	exit -1
fi


# Set up IP address of the external network interface
IF_EXT_IPADDRESS=192.168.2.${VEHICLE_ID}


##----------------------------------------------------------------------------
## ENABLE MASQUERADING AND FORWARDING BETWEEN NETWORK INTERFACES
##----------------------------------------------------------------------------
## Forward connections between interfaces
$IPTABLES -A FORWARD -i ${IF_EXT} -o ${IF_INT} -j ACCEPT
$IPTABLES -A FORWARD -i ${IF_INT} -o ${IF_EXT} -j ACCEPT
$IPTABLES -A FORWARD -j LOG

## Masquerade: The source IP address of all outgoing packets 
## will be set to the IP address of the external interface
${IPTABLES} -t nat -A POSTROUTING -o ${IF_EXT} -j MASQUERADE




##----------------------------------------------------------------------------
## PORT FORWARDING FOR PICARD
##----------------------------------------------------------------------------
# These are the port aliases on the WiFi interface mapped to Picard
PORT_PICARD_SSH=9999
PORT_PICARD_FTPD=10020
PORT_PICARD_FTPC=10021
PORT_PICARD_TFTP=10069
PORT_PICARD_SFTP=10115
#PORT_PICARD_MOOSDB=9000
PORT_PICARD_MOOSHTTP=9080

## Forward SSH port to Picard
${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_SSH} \
            -j DNAT --to ${PICARD_IP}:${PORT_SSH}


# Forward FTP data and control ports to Picard
${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_FTPD} \
            -j DNAT --to ${PICARD_IP}:${PORT_FTP_DATA}

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_FTPC} \
            -j DNAT --to ${PICARD_IP}:${PORT_FTP_CONTROL}


## Forward TFTP and SFTP ports to Picard
${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_TFTP} \
            -j DNAT --to ${PICARD_IP}:${PORT_TFTP}

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_SFTP} \
            -j DNAT --to ${PICARD_IP}:${PORT_SFTP}


## Forward MOOS Database comms and HTTP ports to Picard
#${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
#            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_MOOSDB} \
#            -j DNAT --to ${PICARD_IP}:${PORT_PICARD_MOOSDB}

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_PICARD_MOOSHTTP} \
            -j DNAT --to ${PICARD_IP}:${PORT_PICARD_MOOSHTTP}


##----------------------------------------------------------------------------
## PORT FORWARDING FOR SPOCK
##----------------------------------------------------------------------------
# Spock communicates via Bunnysock on this port
PORT_SPOCK_BSOCK=20023

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_SPOCK_BSOCK} \
            -j DNAT --to ${SPOCK_IP}:${PORT_SPOCK_BSOCK}


##----------------------------------------------------------------------------
## PORT FORWARDING FOR SCOTTY
##----------------------------------------------------------------------------
# Scotty communicates via Bunnysock on this port
PORT_SCOTTY_BSOCK=20024

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_SCOTTY_BSOCK} \
            -j DNAT --to ${SCOTTY_IP}:${PORT_SCOTTY_BSOCK}



##----------------------------------------------------------------------------
## PORT FORWARDING FOR DSP
##----------------------------------------------------------------------------
# DSP communicates via Bunnysock on this port
PORT_DSP_BSOCK=20025

# DSP FTP port aliases at the WiFi connection
PORT_DSP_FTPD=11020
PORT_DSP_FTPC=11021

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_DSP_BSOCK} \
            -j DNAT --to ${DSP_IP}:${PORT_DSP_BSOCK}

# Forward FTP data and control ports to the DSP
${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_DSP_FTPD} \
            -j DNAT --to ${DSP_IP}:${PORT_FTP_DATA}

${IPTABLES} -t nat -A PREROUTING -p tcp -i ${IF_EXT} \
            -d ${IF_EXT_IPADDRESS} --dport ${PORT_DSP_FTPC} \
            -j DNAT --to ${DSP_IP}:${PORT_FTP_CONTROL}


iptables-save > ${NATCONFIG_FILE}
echo "Saved iptables configuration to :"${NATCONFIG_FILE}
echo

